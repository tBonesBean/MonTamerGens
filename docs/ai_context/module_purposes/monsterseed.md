# **monsterseed.md ‚Äî Module Purpose & Technical Canon**  
_Describes the role, responsibilities, data flow, and invariants of `monsterseed.py`._

---

# üß© **1. Purpose of This Module**

`monsterseed.py` defines the **MonsterSeed**, the foundational blueprint for every creature generated by MonTamerGens. It is the first stage of the generation pipeline and establishes:

- identity  
- type pairing  
- form/species  
- habitat  
- base stats  
- physical traits  
- held items  
- tempers  
- initial mutagens  
- meta tags  

A MonsterSeed is **not** a final monster ‚Äî it is the deterministic ‚Äúintent snapshot‚Äù from which all later stages (mutagens, naming, visuals, dex entries) derive.

This module is the **root of determinism** in the entire engine.

---

# üß± **2. Responsibilities**

`monsterseed.py` is responsible for:

### ‚úî Type selection  
- Weighted primary type selection  
- Optional secondary type selection  
- Respecting incompatibility rules  
- Applying synergy boosts  

### ‚úî Form (species) selection  
- Pulls from YAML (`type_forms.yaml`)  
- Supports dict (weighted) or list (simple) structures  

### ‚úî Habitat selection  
- Pulls from YAML (`seed_types.yaml`)  
- Supports dict or list structures  

### ‚úî Base stat calculation  
- Applies primary type multipliers/additions  
- Applies secondary type modifiers at 50% strength  
- Uses `BASE_STATS` as the foundation  

### ‚úî Initial mutagen pre‚Äëselection  
- One major + one utility mutagen  
- Weighted by rarity  
- Filtered by allowed types  

### ‚úî Physical trait selection  
- 75% chance of 1 trait  
- 25% chance of 2 traits  
- Weighted selection from YAML  

### ‚úî Temper selection  
- Mood + affinity from `TEMPERS_COUPLED`  

### ‚úî Held item selection  
- 40% chance of receiving an item  

### ‚úî Meta extraction  
- Tags, resistances, weaknesses from type definitions  

### ‚úî Deterministic construction  
- All randomness is seedable  
- All choices are weighted and stable  

---

# üß¨ **3. Inputs & Data Dependencies**

`monsterseed.py` consumes the following data structures from `data.py`:

- `SEED_TYPES`  
- `SEED_TYPES_WEIGHTED`  
- `SEED_TYPE_DATA`  
- `FORMS_BY_TYPE`  
- `BASE_STATS`  
- `PHYSICAL_TRAITS`  
- `HELD_ITEMS`  
- `TEMPERS_COUPLED`  
- `MAJOR_MODS`  
- `UTILITY_MODS`  
- `TYPE_SYNERGY_BOOSTS`  
- `INCOMPATIBLE_TYPE_PAIRS`  

It also consumes YAML content indirectly through `data.py`.

---

# üîÑ **4. Data Flow**

```
seed_types.yaml
type_forms.yaml
traits.yaml
items.yaml
tempers.yaml
    ‚Üì
data.py (loads + normalizes)
    ‚Üì
MonsterSeed.forge()
    ‚Üì
Mutagen pre-selection
    ‚Üì
Base stats + meta
    ‚Üì
Seed returned to mon_forge
```

This module is the **first stage** of the pipeline.

---

# üß† **5. Key Functions**

## **5.1 weighted_choice()**
A deterministic weighted random selector.  
Supports:

- dicts  
- lists of tuples  
- nested dicts with `weight` keys  

Used throughout the module for:

- type selection  
- form selection  
- habitat selection  
- trait selection  
- temper selection  
- held item selection  
- mutagen pre‚Äëselection  

---

## **5.2 choose_type_pair()**
Selects:

- primary type  
- optional secondary type  

Respects:

- weighted probabilities  
- incompatibility rules  
- synergy boosts  

This function is the **canonical type pairing engine**.

---

## **5.3 MonsterSeed.forge()**
The heart of the module.

This method:

1. Selects primary/secondary types  
2. Selects form  
3. Selects habitat  
4. Selects initial mutagens  
5. Selects tempers  
6. Selects physical traits  
7. Selects held item  
8. Computes base stats  
9. Computes base meta  
10. Constructs the MonsterSeed dataclass  

This is the **entry point** for all monster generation.

---

## **5.4 calculate_base_stats()**
Applies:

- primary type multipliers/additions  
- secondary type modifiers at 50% strength  

This ensures:

- emergent stats  
- type‚Äëdriven identity  
- deterministic shaping  

---

## **5.5 get_base_meta()**
Extracts:

- tags  
- resistances  
- weaknesses  

From:

- `SEED_TYPE_DATA[type]["tags"]`  
- or `meta.tags`  
- or `attributes.tags`  

This supports legacy and new YAML shapes.

---

# üß¨ **6. Output Shape**

A MonsterSeed has the following structure:

```python
MonsterSeed(
    idnum: int,
    name: str,
    form: str,
    primary_type: str,
    secondary_type: Optional[str],
    stats: Dict[str, int],
    mutagens: Dict[str, List[str]],
    habitat: str,
    physical_traits: List[str],
    held_item: Optional[str],
    tempers: Dict[str, str],
    meta: Dict[str, Any],
)
```

This object is passed directly into `mon_forge.apply_mutagens()`.

---

# üß© **7. Invariants & Guarantees**

- A MonsterSeed is always valid.  
- Types always exist in `SEED_TYPES`.  
- Secondary types never equal primary types.  
- Incompatible pairs are never selected.  
- Stats are always integers.  
- Mutagens always exist in the dict.  
- Meta always contains `tags`, `resist`, `weak`.  
- Form and habitat always resolve to a string.  
- All randomness is deterministic when seeded.  

---

# ‚ö†Ô∏è **8. Known Pitfalls / Refactor Notes**

### 1. Mutagen pre‚Äëselection is duplicated  
`monsterseed.py` selects one major + one utility mutagen.  
`mon_forge.py` selects additional mutagens.

This is fine, but should be documented clearly.

### 2. YAML shape drift  
`tags` may appear under:

- `type_entry["tags"]`  
- `type_entry["meta"]["tags"]`  
- `type_entry["attributes"]["tags"]`  

This is handled gracefully, but should be standardized later.

### 3. Form selection fallback  
If YAML is missing forms, fallback is `"Unknown"`.

---

# üöÄ **9. Future Expansion Hooks**

- Move mutagen pre‚Äëselection fully into `mon_forge`  
- Add silhouette selection  
- Add narrative hooks (Kin Wound, Kin Spark)  
- Add biome‚Äëdriven stat modifiers  
- Add emotional resonance variables  
- Add evolution seed data  

---

# üü¶ **10. AI Usage Notes**

When an AI agent interacts with this module, it should:

- never invent new fields  
- never assume a stat exists unless in `BASE_STATS`  
- always respect the YAML shapes  
- always treat MonsterSeed as immutable after creation  
- always use `MonsterSeed.forge()` as the entry point  
- never bypass type selection logic  
- never mutate stats before mutagens are applied  

---

